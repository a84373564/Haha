import json
import shutil
from pathlib import Path

MAX_HISTORY = 1000
MAX_ARCHIVES = 100
MAX_LOGS = 100

def score_memory(entry):
    score = 0
    if entry.get("return_pct", 0) > 0: score += 1
    if entry.get("win_rate", 0) > 50: score += 1
    if entry.get("sharpe", 0) > 1: score += 1
    if entry.get("drawdown", 100) < 5: score += 1
    if entry.get("net_profit", 0) > 0: score += 1
    return score

# 路徑
mem_path = Path("~/Killcore/king_memory.json").expanduser()
archive_path = Path("~/Killcore/archives").expanduser()
log_path = Path("~/Killcore/logs").expanduser()

if not mem_path.exists():
    raise FileNotFoundError("找不到 king_memory.json")

memory = json.loads(mem_path.read_text())

# 自動補欄
required_fields = {
    "live_rounds": 0,
    "fail_indicators_count": {},
    "history": [],
    "style_profile": None,
    "learning_score": 0,
    "memory_flags": {},
    "aging_map": {},
    "fail_pattern_stats": {},
    "evolution_trace": []
}
for k, default in required_fields.items():
    if k not in memory:
        memory[k] = default

# 保護演化風格與意圖
protected_indices = set()
seen_styles = set()
seen_intents = set()
for trace in memory.get("evolution_trace", []):
    style = trace.get("style_profile")
    intent = tuple(trace.get("intent", []))
    gen = trace.get("generation")
    if style and style not in seen_styles:
        seen_styles.add(style)
        protected_indices.add(gen)
    if intent and intent not in seen_intents:
        seen_intents.add(intent)
        protected_indices.add(gen)

# 打分與選擇
scored = []
for i, h in enumerate(memory["history"]):
    gen = h.get("generation", i)
    score = score_memory(h)
    is_protected = gen in protected_indices or score >= 4
    scored.append((i, h, score, is_protected))

scored.sort(key=lambda x: (x[3], x[2]), reverse=True)
final_pool = scored[:MAX_HISTORY]
final_indices = {i for i, _, _, _ in final_pool}

new_history, new_aging_map = [], {}
for i, h in enumerate(memory["history"]):
    if i in final_indices:
        new_history.append(h)
    else:
        new_aging_map[str(i)] = f"淘汰（score={score_memory(h):.1f}）"

memory["history"] = new_history
memory["aging_map"] = new_aging_map

# 清理資料夾中多餘檔案或資料夾
def clean_folder(path: Path, keep: int):
    if not path.exists(): return
    files = sorted(path.iterdir(), key=lambda f: f.stat().st_mtime, reverse=True)
    for f in files[keep:]:
        try:
            if f.is_file():
                f.unlink()
            elif f.is_dir():
                shutil.rmtree(f)
        except Exception as e:
            print(f"刪除失敗 {f.name}: {e}")

clean_folder(archive_path, MAX_ARCHIVES)
clean_folder(log_path, MAX_LOGS)

# 儲存記憶
mem_path.write_text(json.dumps(memory, indent=2, ensure_ascii=False))
print(f"[Memory Regulator] 智慧清理完成 ｜ 紀錄數={len(memory['history'])}，進化={len(memory['evolution_trace'])}，封存淘汰={len(memory['aging_map'])}")
